name: Build AndroidAPS on my PC (debug update)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: [self-hosted, Windows, X64]
    timeout-minutes: 240

    steps:
      - name: Checkout (clean)
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      - name: Force clean working tree
        shell: pwsh
        run: |
          Write-Host "Git status before cleanup:"
          git status --porcelain
          
          # Reset any changes
          git reset --hard HEAD
          git clean -xfd
          
          Write-Host "Git status after cleanup:"
          git status --porcelain
          
          # Fail if still not clean
          if (git status --porcelain) {
            Write-Host "ERROR: Git tree is not clean after cleanup!"
            exit 1
          }

      - name: Set JAVA_HOME from Android Studio JBR
        shell: pwsh
        run: |
          # Try multiple possible paths for JBR
          $jbrPaths = @(
            "C:\Program Files\Android\Android Studio\jbr",
            "C:\Users\maksi\AppData\Local\Android\android-studio\jbr",
            "$env:LOCALAPPDATA\Android\android-studio\jbr",
            "$env:ProgramFiles\Android\Android Studio\jbr"
          )
          
          $foundJbr = $null
          foreach ($path in $jbrPaths) {
            if (Test-Path $path) {
              $foundJbr = $path
              break
            }
          }
          
          if (-not $foundJbr) {
            # Fallback to JAVA_HOME from environment
            if ($env:JAVA_HOME) {
              $foundJbr = $env:JAVA_HOME
            } else {
              throw "Android Studio JBR not found in common locations and JAVA_HOME not set"
            }
          }
          
          "JAVA_HOME=$foundJbr" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "$foundJbr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "Using JAVA_HOME: $foundJbr"
          java -version

      - name: Check Gradle wrapper
        shell: pwsh
        run: |
          # Check if gradlew exists
          if (-not (Test-Path "gradlew")) {
            throw "gradlew not found!"
          }
          
          # Make sure gradlew is executable
          Write-Host "Gradle wrapper exists"
          .\gradlew --version

      - name: Build AAPS Client Debug
        shell: pwsh
        run: |
          # Set environment variables for Gradle memory (instead of modifying gradle.properties)
          $env:GRADLE_OPTS = "-Xmx4g -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8"
          $env:JAVA_OPTS = "-Xmx4g"
          
          # First, list available tasks to see what's there
          Write-Host "Listing available assemble tasks..."
          .\gradlew :app:tasks --all --no-daemon | Select-String "assemble" | ForEach-Object { Write-Host "  $_" }
          
          # Try different possible task names
          $possibleTasks = @(
            "assembleAapsclientDebug",
            "assembleDebug",
            "assembleFullDebug",
            "assembleClientDebug"
          )
          
          $success = $false
          foreach ($task in $possibleTasks) {
            Write-Host "`nTrying task: $task"
            try {
              .\gradlew ":app:$task" --no-daemon --stacktrace --info
              $success = $true
              Write-Host "Successfully built with task: $task"
              break
            } catch {
              Write-Host "Task $task failed: $_"
            }
          }
          
          if (-not $success) {
            # Last resort: try generic assembleDebug
            Write-Host "`nTrying generic assembleDebug..."
            .\gradlew assembleDebug --no-daemon --stacktrace --info
          }

      - name: Find built APK
        shell: pwsh
        run: |
          # Search for APK files
          $apk = Get-ChildItem -Recurse -Filter *.apk -Path "app" | Where-Object {
            $_.FullName -match "outputs" -and 
            $_.FullName -notmatch "test" -and
            $_.FullName -notmatch "kotlin"
          } | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          
          if (-not $apk) {
            # Try broader search
            $apk = Get-ChildItem -Recurse -Filter *.apk | Where-Object {
              $_.FullName -match "build" -and $_.FullName -match "apk"
            } | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          }
          
          if (-not $apk) {
            Write-Host "APK files found in the project:"
            Get-ChildItem -Recurse -Filter *.apk | ForEach-Object { Write-Host "  $($_.FullName)" }
            throw "APK not found in expected locations"
          }
          
          "APK_PATH=$($apk.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Found APK: $($apk.FullName)"
          Write-Host "APK Size: $($apk.Length / 1MB) MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aaps-debug-apk
          path: ${{ env.APK_PATH }}
          retention-days: 7
