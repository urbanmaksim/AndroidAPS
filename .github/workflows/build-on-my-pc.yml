name: Build AndroidAPS on my PC (debug update)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: [self-hosted, Windows, X64]
    timeout-minutes: 240

    steps:
      - name: Checkout (clean)
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      - name: Force clean working tree
        shell: pwsh
        run: |
          Write-Host "Git status before cleanup:"
          git status --porcelain
          
          # Reset any changes
          git reset --hard HEAD
          git clean -xfd -e .gradle/ -e .idea/
          
          Write-Host "Git status after cleanup:"
          git status --porcelain
          
          # Fail if still not clean
          if (git status --porcelain) {
            Write-Host "ERROR: Git tree is not clean after cleanup!"
            exit 1
          }

      - name: Set JAVA_HOME from Android Studio JBR
        shell: pwsh
        run: |
          # Try multiple possible paths for JBR
          $jbrPaths = @(
            "C:\Program Files\Android\Android Studio\jbr",
            "C:\Users\maksi\AppData\Local\Android\android-studio\jbr",
            "$env:LOCALAPPDATA\Android\android-studio\jbr",
            "$env:ProgramFiles\Android\Android Studio\jbr"
          )
          
          $foundJbr = $null
          foreach ($path in $jbrPaths) {
            if (Test-Path $path) {
              $foundJbr = $path
              break
            }
          }
          
          if (-not $foundJbr) {
            # Fallback to JAVA_HOME from environment
            if ($env:JAVA_HOME) {
              $foundJbr = $env:JAVA_HOME
            } else {
              throw "Android Studio JBR not found in common locations and JAVA_HOME not set"
            }
          }
          
          "JAVA_HOME=$foundJbr" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "$foundJbr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "Using JAVA_HOME: $foundJbr"
          java -version

      - name: Check Gradle wrapper
        shell: pwsh
        run: |
          # Check if gradlew exists
          if (-not (Test-Path "gradlew")) {
            throw "gradlew not found!"
          }
          
          # Make sure gradlew is executable
          Write-Host "Gradle wrapper exists"
          .\gradlew --version

      - name: Clean and build AAPS Client Debug
        shell: pwsh
        run: |
          # Set minimal environment variables
          $env:GRADLE_OPTS = "-Xmx2g -Dfile.encoding=UTF-8"
          
          # First clean everything
          Write-Host "Cleaning project..."
          .\gradlew clean --no-daemon --stacktrace
          
          # Try to find the correct task
          Write-Host "`nListing available assemble tasks..."
          $tasksOutput = .\gradlew :app:tasks --all --no-daemon
          $assembleTasks = $tasksOutput | Select-String "assemble" | ForEach-Object { $_.ToString().Trim() }
          $assembleTasks | ForEach-Object { Write-Host "  $_" }
          
          # Try specific tasks in order of likelihood
          $tasksToTry = @(
            "assembleAapsclientDebug",
            "assembleFullDebug", 
            "assembleDebug",
            "assemble"
          )
          
          $success = $false
          foreach ($task in $tasksToTry) {
            Write-Host "`n=== Trying to build with task: :app:$task ==="
            try {
              # Run with minimal options
              .\gradlew ":app:$task" --no-daemon --stacktrace
              $success = $true
              Write-Host "`n✓ Successfully built with task: :app:$task"
              break
            } catch {
              Write-Host "`n✗ Task :app:$task failed"
              Write-Host "Error: $_"
            }
          }
          
          if (-not $success) {
            throw "All build attempts failed."
          }

      - name: Find built APK
        shell: pwsh
        run: |
          # Search for APK files in the standard location
          $apkPath = "app\build\outputs\apk"
          if (Test-Path $apkPath) {
            $apk = Get-ChildItem -Path $apkPath -Recurse -Filter *.apk | 
                   Where-Object { $_.Name -match "debug" -and $_.Name -match "aaps" } |
                   Sort-Object LastWriteTime -Descending | 
                   Select-Object -First 1
          }
          
          if (-not $apk) {
            # Broader search
            $apk = Get-ChildItem -Path "." -Recurse -Filter *.apk |
                   Where-Object { $_.FullName -match "build" -and $_.FullName -match "apk" -and $_.Name -match "debug" } |
                   Sort-Object LastWriteTime -Descending |
                   Select-Object -First 1
          }
          
          if (-not $apk) {
            Write-Host "Available APK files:"
            Get-ChildItem -Recurse -Filter *.apk | ForEach-Object { Write-Host "  $($_.FullName)" }
            throw "Could not find APK file"
          }
          
          $apkPath = $apk.FullName
          "APK_PATH=$apkPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Found APK: $apkPath"
          Write-Host "APK Size: $([math]::Round($apk.Length / 1MB, 2)) MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aaps-debug-apk
          path: ${{ env.APK_PATH }}
          retention-days: 7
