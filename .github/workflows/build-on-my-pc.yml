name: Build AndroidAPS on my PC (debug update)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: [self-hosted, Windows, X64]
    timeout-minutes: 240

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set JAVA_HOME from Android Studio JBR
        shell: pwsh
        run: |
          $jbr1 = "C:\Program Files\Android\Android Studio\jbr"
          $jbr2 = "C:\Users\maksi\AppData\Local\Programs\Android Studio\jbr"
          if (Test-Path $jbr1) { $jbr = $jbr1 }
          elseif (Test-Path $jbr2) { $jbr = $jbr2 }
          else { throw "Android Studio JBR not found" }

          "JAVA_HOME=$jbr" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "$jbr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          java -version

      - name: Increase Gradle + Kotlin memory
        shell: pwsh
        run: |
          Add-Content gradle.properties "`norg.gradle.jvmargs=-Xmx6g -XX:MaxMetaspaceSize=1g -Dfile.encoding=UTF-8"
          Add-Content gradle.properties "kotlin.daemon.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g"
          Add-Content gradle.properties "org.gradle.workers.max=1"
          Add-Content gradle.properties "org.gradle.parallel=false"
          Get-Content gradle.properties

      - name: Pick and build AAPS Client Debug
        shell: pwsh
        run: |
          $tasksText = .\gradlew -q :app:tasks --all
          $tasks = $tasksText -split "`n" | ForEach-Object { ($_ -split "\s+")[0].Trim() }

          $cand = $tasks | Where-Object { $_ -match '^assemble.*aapsclient.*Debug$' } | Select-Object -First 1
          if (-not $cand) {
            Write-Host "Available assemble tasks:"
            $tasks | Where-Object { $_ -match '^assemble' } | Sort-Object
            throw "AAPS client debug task not found"
          }

          Write-Host "Using task: :app:$cand"
          .\gradlew ":app:$cand" --no-daemon --no-parallel --max-workers=1 --stacktrace -x test -x lint -x check

      - name: Find built APK
        shell: pwsh
        run: |
          $apk = Get-ChildItem -Recurse -Filter *.apk | Where-Object {
            $_.FullName -match "build\\outputs\\apk" -and
            $_.FullName -match "aapsclient"
          } | Select-Object -First 1

          if (-not $apk) {
            Get-ChildItem -Recurse -Filter *.apk
            throw "APK not found"
          }

          "APK_PATH=$($apk.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "APK: $($apk.FullName)"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aaps-debug-apk
          path: ${{ env.APK_PATH }}
