name: Build AndroidAPS on my PC (debug update)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: [self-hosted, Windows, X64]
    timeout-minutes: 240

    steps:
      - name: Checkout (clean)
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      - name: Force clean working tree (AAPS requires clean git)
        shell: pwsh
        run: |
          git reset --hard
          git clean -xfd
          Write-Host "git status --porcelain:"
          git status --porcelain

      - name: Set JAVA_HOME from Android Studio JBR
        shell: pwsh
        run: |
          $jbr1 = "C:\Program Files\Android\Android Studio\jbr"
          $jbr2 = "C:\Users\maksi\AppData\Local\Programs\Android Studio\jbr"
          if (Test-Path $jbr1) { $jbr = $jbr1 }
          elseif (Test-Path $jbr2) { $jbr = $jbr2 }
          else { throw "Android Studio JBR not found" }

          "JAVA_HOME=$jbr" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "$jbr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          java -version

      - name: Set Gradle/Kotlin memory (NOT in repo)
        shell: pwsh
        run: |
          $gradleHome = Join-Path $env:USERPROFILE ".gradle"
          New-Item -ItemType Directory -Force -Path $gradleHome | Out-Null
          $gp = Join-Path $gradleHome "gradle.properties"

          @"
org.gradle.daemon=false
org.gradle.parallel=false
org.gradle.workers.max=1
org.gradle.jvmargs=-Xmx6g -XX:MaxMetaspaceSize=1g -Dfile.encoding=UTF-8
kotlin.daemon.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g
"@ | Set-Content -Encoding ASCII $gp

          Write-Host "Wrote $gp"
          Get-Content $gp

      - name: Ensure repo still clean before build
        shell: pwsh
        run: |
          Write-Host "git status --porcelain (must be empty):"
          $s = git status --porcelain
          if ($s) { $s | Out-Host; throw "Repo is dirty before build" }

      - name: Pick and build AAPS Client Debug
        shell: pwsh
        run: |
          $tasksText = .\gradlew -q :app:tasks --all
          $tasks = $tasksText -split "`n" | ForEach-Object { ($_ -split "\s+")[0].Trim() }
          $cand = $tasks | Where-Object { $_ -match '^assemble.*aapsclient.*Debug$' } | Select-Object -First 1

          if (-not $cand) {
            Write-Host "Available assemble tasks:"
            $tasks | Where-Object { $_ -match '^assemble' } | Sort-Object
            throw "AAPS client debug task not found"
          }

          Write-Host "Using task: :app:$cand"
          .\gradlew ":app:$cand" --no-daemon --no-parallel --max-workers=1 --stacktrace -x test -x lint -x check

      - name: Find built APK
        shell: pwsh
        run: |
          $apk = Get-ChildItem -Recurse -Filter *.apk | Where-Object {
            $_.FullName -match "build\\outputs\\apk" -and $_.FullName -match "aapsclient"
          } | Select-Object -First 1

          if (-not $apk) {
            Write-Host "APK list under build/outputs/apk:"
            Get-ChildItem -Recurse -Filter *.apk | Where-Object { $_.FullName -match "build\\outputs\\apk" } | Select-Object FullName
            throw "APK not found"
          }

          "APK_PATH=$($apk.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "APK: $($apk.FullName)"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aaps-debug-apk
          path: ${{ env.APK_PATH }}
