name: Build AndroidAPS (debug-signed for update)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    env:
      # Gradle/JVM limits to avoid runner kill
      GRADLE_OPTS: >
        -Dorg.gradle.daemon=false
        -Dorg.gradle.parallel=false
        -Dorg.gradle.configureondemand=false
        -Dorg.gradle.caching=false
        -Dorg.gradle.jvmargs=-Xmx1536m -XX:MaxMetaspaceSize=512m -Dfile.encoding=UTF-8
        -Dkotlin.daemon.jvm.options=-Xmx512m

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Disable Gradle cache (stability)
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-disabled: true

      - name: Grant execute to gradlew
        run: chmod +x ./gradlew

      - name: Show candidate assemble tasks
        shell: bash
        run: |
          set -euo pipefail
          ./gradlew -q :app:tasks --all | tr -d '\r' | awk '{print $1}' | grep -Ei '^assemble.*aapsclient.*Debug$' || true
          echo "----"
          echo "All assemble tasks (first 120):"
          ./gradlew -q :app:tasks --all | tr -d '\r' | awk '{print $1}' | grep -E '^assemble' | head -n 120 || true

      - name: Pick and build AAPS Client Debug (min resources)
        shell: bash
        run: |
          set -euo pipefail

          TASKS="$(./gradlew -q :app:tasks --all | tr -d '\r' | awk '{print $1}')"
          CANDIDATE="$(echo "$TASKS" | grep -Ei '^assemble.*aapsclient.*Debug$' | head -n 1 || true)"

          if [ -z "$CANDIDATE" ]; then
            echo "No assemble*aapsclient*Debug task found"
            exit 1
          fi

          echo "Using task: :app:$CANDIDATE"

          ./gradlew ":app:$CANDIDATE" \
            --no-daemon \
            --no-parallel \
            --no-configuration-cache \
            --max-workers=1 \
            --stacktrace \
            -x test -x lint -x check

      - name: Decode debug.keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > debug.keystore
          ls -la debug.keystore

      - name: Pick latest Android build-tools
        run: |
          BT=$(ls -1 "$ANDROID_HOME/build-tools" | sort -V | tail -n 1)
          echo "BT=$BT" >> $GITHUB_ENV
          echo "Using build-tools: $BT"

      - name: Find built APK (prefer aapsclient)
        shell: bash
        run: |
          set -euo pipefail
          find . -maxdepth 12 -type f -name "*.apk" -path "*build/outputs/apk*" -print
          APK_IN=$(find . -maxdepth 12 -type f -name "*.apk" -path "*build/outputs/apk*" | grep -i "aapsclient" | head -n 1 || true)
          if [ -z "$APK_IN" ]; then
            echo "No aapsclient APK found"
            exit 1
          fi
          echo "APK_IN=$APK_IN" >> $GITHUB_ENV
          echo "Using APK: $APK_IN"

      - name: Align APK
        run: |
          "$ANDROID_HOME/build-tools/$BT/zipalign" -f 4 "$APK_IN" aaps-aligned.apk
          ls -la aaps-aligned.apk

      - name: Sign APK (Android Debug)
        run: |
          "$ANDROID_HOME/build-tools/$BT/apksigner" sign \
            --ks debug.keystore \
            --ks-key-alias androiddebugkey \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out aaps-debug-signed.apk \
            aaps-aligned.apk
          ls -la aaps-debug-signed.apk

      - name: Verify signature
        run: |
          "$ANDROID_HOME/build-tools/$BT/apksigner" verify --print-certs aaps-debug-signed.apk

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aaps-debug-signed
          path: aaps-debug-signed.apk
