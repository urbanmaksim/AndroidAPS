name: Build AndroidAPS (debug-signed for update)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4
        with:
          clean: true

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK (with JDK 17 compatibility)
        run: |
          export ANDROID_HOME=/usr/local/lib/android/sdk
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          
          # Išvalyti seną SDK, jei yra
          if [ -d "$ANDROID_HOME" ]; then
            echo "Cleaning existing Android SDK..."
            rm -rf "$ANDROID_HOME"
          fi
          
          sudo mkdir -p $ANDROID_HOME
          sudo chmod -R 777 $ANDROID_HOME
          
          # Download command line tools version that supports JDK 17
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip
          
          # Sukurti katalogų struktūrą
          mkdir -p $ANDROID_HOME/cmdline-tools
          
          # Perkelti cmdline-tools į tinkamą vietą
          # Atkreipkite dėmesį: cmdline-tools kataloge yra bin, lib, source.properties
          # Jį reikia perkelti į cmdline-tools/latest
          mv cmdline-tools $ANDROID_HOME/cmdline-tools/latest
          
          rm -f commandlinetools-linux-9477386_latest.zip
          
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
          
          # Priimti licencijas (naudojame pipe)
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
          
          # Įdiegti reikiamus paketus
          echo "Installing platform-tools..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" --verbose
          
          echo "Installing Android SDK Platform 34..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-34" --verbose
          
          echo "Installing build-tools 34.0.0..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;34.0.0" --verbose
          
          # NDK gali būti reikalingas
          echo "Installing NDK..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;25.2.9519653" --verbose || echo "NDK installation failed or already installed"
          
          echo "Android SDK setup complete"

      - name: Setup Gradle (no cache)
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-disabled: true

      - name: Clean git state
        run: |
          git reset --hard HEAD
          git clean -xfd
          git status

      - name: Debug info
        run: |
          echo "=== Debug Information ==="
          java -version
          echo "JAVA_HOME: $JAVA_HOME"
          echo "ANDROID_HOME: $ANDROID_HOME"
          ls -la $ANDROID_HOME/cmdline-tools/latest/
          ./gradlew --version

      - name: Build AAPS Debug
        run: |
          # Išvalyti
          ./gradlew clean --stacktrace
          
          echo "=== Building AAPS ==="
          # Bandyti įvairius build variantus
          if ./gradlew :app:assembleAapsclientDebug --stacktrace --info; then
            echo "Build successful with :app:assembleAapsclientDebug"
          elif ./gradlew :app:assembleDebug --stacktrace --info; then
            echo "Build successful with :app:assembleDebug"
          elif ./gradlew assembleDebug --stacktrace --info; then
            echo "Build successful with assembleDebug"
          else
            echo "All build attempts failed"
            echo "=== Listing tasks ==="
            ./gradlew tasks --all | grep assemble || true
            exit 1
          fi

      - name: Find built APK
        id: find-apk
        run: |
          # Ieškoti APK
          APK_PATH=$(find app/build -name "*.apk" -type f 2>/dev/null | grep -i "debug" | head -1)
          
          if [ -z "$APK_PATH" ]; then
            echo "ERROR: No APK found!"
            echo "Checking build outputs..."
            find app/build -type f -name "*.apk" 2>/dev/null
            find app/build/outputs -type f 2>/dev/null | head -20
            exit 1
          fi
          
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "Selected APK: $APK_PATH ($(stat -c%s "$APK_PATH") bytes)"

      - name: Decode and verify debug.keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > debug.keystore
          
          echo "=== Keystore Verification ==="
          echo "File size: $(wc -c < debug.keystore) bytes"
          
          # Patikrinti keystore
          if ! keytool -list -v -keystore debug.keystore \
            -storepass "${{ secrets.KEY_PASSWORD }}" \
            -alias "${{ secrets.KEY_ALTAS }}" 2>/dev/null; then
            echo "❌ ERROR: Failed to read keystore"
            exit 1
          fi
          
          ACTUAL_SHA1=$(keytool -list -v -keystore debug.keystore \
            -storepass "${{ secrets.KEY_PASSWORD }}" \
            -alias "${{ secrets.KEY_ALTAS }}" 2>/dev/null | \
            grep -i "SHA1:" | head -1 | awk '{print $2}' | tr -d ':' | tr '[:upper:]' '[:lower:]')
          
          echo "SHA1 from keystore: $ACTUAL_SHA1"
          echo "Expected SHA1: a8de9afa8551901e06d7312bc7ce33e24318ddbc"
          
          if [ "$ACTUAL_SHA1" = "a8de9afa8551901e06d7312bc7ce33e24318ddbc" ]; then
            echo "✅ SUCCESS: Keystore matches! APK will be updatable."
          else
            echo "❌ ERROR: Keystore mismatch!"
            exit 1
          fi

      - name: Sign APK
        run: |
          BUILD_TOOLS_DIR="$ANDROID_HOME/build-tools/34.0.0"
          echo "Using build-tools: $BUILD_TOOLS_DIR"
          
          # Align APK
          $BUILD_TOOLS_DIR/zipalign -f -p 4 "$APK_PATH" aligned.apk
          
          # Sign APK
          $BUILD_TOOLS_DIR/apksigner sign \
            --ks debug.keystore \
            --ks-key-alias "${{ secrets.KEY_ALTAS }}" \
            --ks-pass pass:"${{ secrets.KEY_PASSWORD }}" \
            --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
            --out aaps-debug-signed.apk \
            aligned.apk
          
          echo "=== Signed APK Info ==="
          ls -la aaps-debug-signed.apk
          
          # Verify
          $BUILD_TOOLS_DIR/apksigner verify --verbose aaps-debug-signed.apk

      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: aaps-debug-signed
          path: aaps-debug-signed.apk
          retention-days: 7
