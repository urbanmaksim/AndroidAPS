name: Build AndroidAPS (debug-signed for update)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4

      # AndroidAPS requires Java 11
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "11"

      # Setup Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
          packages: |
            platform-tools
            platforms;android-34
            build-tools;34.0.0
            cmdline-tools;latest

      - name: Setup Gradle (no cache)
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-disabled: true

      - name: Grant execute to gradlew
        run: chmod +x ./gradlew

      # AAPS requires clean git state
      - name: Clean git state
        run: |
          git reset --hard
          git clean -xfd

      # Tune Gradle memory
      - name: Tune Gradle/Kotlin memory for CI
        run: |
          mkdir -p ~/.gradle
          cat > ~/.gradle/gradle.properties <<'EOF'
          org.gradle.daemon=false
          org.gradle.parallel=false
          org.gradle.workers.max=1
          org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -Dfile.encoding=UTF-8
          kotlin.daemon.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m
          kotlin.incremental=false
          EOF

      # Build AAPS
      - name: Build AAPS Debug
        run: |
          ./gradlew clean
          # Try the specific task, fallback to assembleDebug
          ./gradlew :app:assembleAapsclientDebug || ./gradlew :app:assembleDebug

      # Find the built APK
      - name: Find built APK
        id: find-apk
        run: |
          APK_PATH=$(find app/build/outputs/apk -name "*.apk" -type f | head -1)
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find . -name "*.apk" -type f | grep -i debug | head -1)
          fi
          if [ -z "$APK_PATH" ]; then
            echo "APK not found!"
            exit 1
          fi
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "Found APK: $APK_PATH"

      # Decode the keystore from secret (use the existing one)
      - name: Decode debug.keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > debug.keystore
          # Check the keystore info
          keytool -list -v -keystore debug.keystore -storepass "${{ secrets.KEY_PASSWORD || 'android' }}" -alias "${{ secrets.KEY_ALTAS || 'androiddebugkey' }}" || true

      # Pick latest Android build-tools
      - name: Pick latest Android build-tools
        run: |
          # Use the build-tools version from the SDK setup
          BT=$(ls -1 "$ANDROID_HOME/build-tools" | sort -V | tail -n 1)
          echo "BT=$BT" >> $GITHUB_ENV

      # Align APK
      - name: Align APK
        run: |
          "$ANDROID_HOME/build-tools/$BT/zipalign" -f 4 "$APK_PATH" aaps-aligned.apk

      # Sign APK with the decoded keystore
      - name: Sign APK
        run: |
          "$ANDROID_HOME/build-tools/$BT/apksigner" sign \
            --ks debug.keystore \
            --ks-key-alias "${{ secrets.KEY_ALTAS || 'androiddebugkey' }}" \
            --ks-pass pass:"${{ secrets.KEY_PASSWORD || 'android' }}" \
            --key-pass pass:"${{ secrets.KEY_PASSWORD || 'android' }}" \
            --out aaps-debug-signed.apk \
            aaps-aligned.apk

      # Verify signature
      - name: Verify signature
        run: |
          "$ANDROID_HOME/build-tools/$BT/apksigner" verify --print-certs aaps-debug-signed.apk
          # Also print MD5 to compare with existing APK
          echo "Checking MD5:"
          keytool -printcert -jarfile aaps-debug-signed.apk | grep -i md5

      # Upload artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aaps-debug-signed
          path: aaps-debug-signed.apk
          retention-days: 7
