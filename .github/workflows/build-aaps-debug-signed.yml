name: Build AndroidAPS (debug-signed for update)

on:
  workflow_dispatch:

concurrency:
  group: aaps-debug-signed-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Grant execute to gradlew
        run: chmod +x ./gradlew

      - name: Build Debug APK
        run: ./gradlew assembleDebug

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > debug.keystore

      - name: Pick latest Android build-tools
        run: |
          BT=$(ls -1 "$ANDROID_HOME/build-tools" | sort -V | tail -n 1)
          echo "BT=$BT" >> $GITHUB_ENV
          echo "Using build-tools: $BT"

      - name: Find built APK
        run: |
          echo "Listing APK outputs:"
          find . -maxdepth 12 -type f -name "*.apk" -path "*build/outputs/apk*" -print

          APK_IN=$(find . -maxdepth 12 -type f -name "*.apk" -path "*build/outputs/apk*" | head -n 1)
          if [ -z "$APK_IN" ]; then
            echo "No APK found under *build/outputs/apk*"
            exit 1
          fi

          echo "APK_IN=$APK_IN" >> $GITHUB_ENV
          echo "Using APK: $APK_IN"

      - name: Align APK
        run: |
          "$ANDROID_HOME/build-tools/$BT/zipalign" -f 4 "$APK_IN" aaps-aligned.apk

      - name: Sign APK
        run: |
          "$ANDROID_HOME/build-tools/$BT/apksigner" sign \
            --ks debug.keystore \
            --ks-pass pass:${{ secrets.KEYSTORE_PASSWORD }} \
            --ks-key-alias ${{ secrets.KEY_ALIAS }} \
            --key-pass pass:${{ secrets.KEY_PASSWORD }} \
            --out aaps-debug-signed.apk \
            aaps-aligned.apk

      - name: Verify signature
        run: |
          "$ANDROID_HOME/build-tools/$BT/apksigner" verify --print-certs aaps-debug-signed.apk

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aaps-debug-signed
          path: aaps-debug-signed.apk
