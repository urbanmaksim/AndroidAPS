name: Build AndroidAPS (debug-signed for update)

on:
  workflow_dispatch:

concurrency:
  group: aaps-debug-signed-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute to gradlew
        run: chmod +x ./gradlew

      # 1) Surandam tikslų "assemble *aapsclient* Debug" taską ir buildinam tik jį
      - name: Build AAPS Client Debug APK only (avoid wear/pumpcontrol)
        shell: bash
        run: |
          set -euo pipefail

          echo "Listing app assemble tasks..."
          TASKS="$(./gradlew -q :app:tasks --all | tr -d '\r')"

          # Paimam pirmą tinkamą taską (skiriasi tarp versijų/branch'ų)
          CANDIDATE="$(echo "$TASKS" | awk '{print $1}' | grep -Ei '^assemble.*aapsclient.*Debug$' | head -n 1 || true)"

          if [ -z "$CANDIDATE" ]; then
            echo "No assemble*aapsclient*Debug task found. Showing assemble tasks:"
            echo "$TASKS" | awk '{print $1}' | grep -E '^assemble' | head -n 200
            exit 1
          fi

          echo "Using Gradle task: :app:${CANDIDATE}"

          # Greitesnis/stabilesnis build GitHub'e
          ./gradlew ":app:${CANDIDATE}" -x test -x lint --no-daemon --stacktrace --warning-mode all

      - name: Decode debug.keystore (from secrets)
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > debug.keystore
          ls -la debug.keystore

      - name: Pick latest Android build-tools
        run: |
          BT=$(ls -1 "$ANDROID_HOME/build-tools" | sort -V | tail -n 1)
          echo "BT=$BT" >> $GITHUB_ENV
          echo "Using build-tools: $BT"

      - name: Find built APK (prefer aapsclient)
        shell: bash
        run: |
          set -euo pipefail
          echo "Searching for APK outputs..."
          find . -maxdepth 12 -type f -name "*.apk" -path "*build/outputs/apk*" -print

          APK_IN=$(find . -maxdepth 12 -type f -name "*.apk" -path "*build/outputs/apk*" | grep -i "aapsclient" | head -n 1 || true)

          if [ -z "$APK_IN" ]; then
            echo "No aapsclient APK found under build/outputs/apk"
            exit 1
          fi

          echo "Using APK: $APK_IN"
          echo "APK_IN=$APK_IN" >> $GITHUB_ENV

      - name: Align APK
        run: |
          "$ANDROID_HOME/build-tools/$BT/zipalign" -f 4 "$APK_IN" aaps-aligned.apk
          ls -la aaps-aligned.apk

      - name: Sign APK (Android Debug)
        run: |
          "$ANDROID_HOME/build-tools/$BT/apksigner" sign \
            --ks debug.keystore \
            --ks-key-alias androiddebugkey \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out aaps-debug-signed.apk \
            aaps-aligned.apk
          ls -la aaps-debug-signed.apk

      - name: Verify signature
        run: |
          "$ANDROID_HOME/build-tools/$BT/apksigner" verify --print-certs aaps-debug-signed.apk

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aaps-debug-signed
          path: aaps-debug-signed.apk
