name: Build AndroidAPS (debug-signed for update)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4
        with:
          clean: true

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "11"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Clean git state
        run: |
          git reset --hard HEAD
          git clean -xfd
          git status

      - name: Build AAPS Debug
        run: |
          ./gradlew clean
          # Try specific task first, then fallback
          if ./gradlew :app:assembleAapsclientDebug --stacktrace; then
            echo "Build successful with assembleAapsclientDebug"
          else
            echo "Trying assembleDebug..."
            ./gradlew :app:assembleDebug --stacktrace
          fi

      - name: Find built APK
        id: find-apk
        run: |
          # Search for APK
          APK_PATH=$(find app/build/outputs/apk -name "*.apk" -type f 2>/dev/null | head -1)
          
          if [ -z "$APK_PATH" ]; then
            echo "APK not found in standard location"
            find . -name "*.apk" -type f | head -5
            exit 1
          fi
          
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "Found APK: $APK_PATH"
          ls -la "$APK_PATH"

      - name: Decode and verify debug.keystore
        run: |
          # Decode keystore from secret
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > debug.keystore
          
          echo "=== Keystore Verification ==="
          echo "File size: $(wc -c < debug.keystore) bytes"
          
          # Get SHA1 from keystore
          KEYTOOL_OUTPUT=$(keytool -list -v -keystore debug.keystore \
            -storepass "${{ secrets.KEY_PASSWORD }}" \
            -alias "${{ secrets.KEY_ALTAS }}" 2>&1)
          
          if echo "$KEYTOOL_OUTPUT" | grep -q "keytool error"; then
            echo "❌ ERROR: Failed to read keystore"
            echo "$KEYTOOL_OUTPUT"
            exit 1
          fi
          
          ACTUAL_SHA1=$(echo "$KEYTOOL_OUTPUT" | grep -i "SHA1:" | head -1 | awk '{print $2}' | tr -d ':' | tr '[:upper:]' '[:lower:]')
          echo "SHA1 from keystore: $ACTUAL_SHA1"
          echo "Expected SHA1: a8de9afa8551901e06d7312bc7ce33e24318ddbc"
          
          if [ "$ACTUAL_SHA1" = "a8de9afa8551901e06d7312bc7ce33e24318ddbc" ]; then
            echo "✅ SUCCESS: Keystore matches! APK will be updatable."
          else
            echo "❌ ERROR: Keystore mismatch!"
            echo "This build will NOT update your existing AAPS."
            exit 1
          fi

      - name: Sign APK
        run: |
          # Find latest build-tools
          BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | sort -V | tail -1)
          echo "Using build-tools: $BUILD_TOOLS_DIR"
          
          # Zipalign
          $BUILD_TOOLS_DIR/zipalign -f -p 4 "$APK_PATH" aligned.apk
          
          # Sign with apksigner
          $BUILD_TOOLS_DIR/apksigner sign \
            --ks debug.keystore \
            --ks-key-alias "${{ secrets.KEY_ALTAS }}" \
            --ks-pass pass:"${{ secrets.KEY_PASSWORD }}" \
            --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
            --out aaps-debug-signed.apk \
            aligned.apk
          
          echo "=== Signed APK Info ==="
          ls -la aaps-debug-signed.apk
          
          # Verify
          $BUILD_TOOLS_DIR/apksigner verify --print-certs aaps-debug-signed.apk

      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: aaps-debug-signed
          path: aaps-debug-signed.apk
          retention-days: 7

      - name: Upload unsigned APK (backup)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: aaps-unsigned
          path: ${{ env.APK_PATH }}
          retention-days: 7
