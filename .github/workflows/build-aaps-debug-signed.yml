name: Build AndroidAPS (debug-signed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Clean Gradle cache
        run: |
          rm -rf ~/.gradle/caches
          ./gradlew --version

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > $GITHUB_WORKSPACE/keystore.jks
          echo "KEYSTORE_PATH=$GITHUB_WORKSPACE/keystore.jks" >> $GITHUB_ENV

      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace --no-daemon
        env:
          JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.17-10/x64
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g"

      - name: Find and verify APK
        run: |
          APK_PATH=$(find . -name "*-debug.apk" -type f | head -1)
          
          if [ -z "$APK_PATH" ]; then
            echo "Error: No debug APK found"
            find . -name "*.apk" -type f
            exit 1
          fi
          
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "Found APK: $APK_PATH"
          ls -lh "$APK_PATH"

      - name: Sign APK with apksigner
        run: |
          BUILD_TOOLS_DIR="$ANDROID_HOME/build-tools/34.0.0"
          
          # Check if build-tools exists, if not find latest
          if [ ! -d "$BUILD_TOOLS_DIR" ]; then
            BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | sort -V | tail -n 1)
          fi
          
          echo "Using build-tools: $BUILD_TOOLS_DIR"
          
          APK_UNSIGNED="${{ env.APK_PATH }}"
          APK_ALIGNED="aligned.apk"
          APK_SIGNED="aaps-signed.apk"
          
          # Zipalign
          echo "Running zipalign..."
          $BUILD_TOOLS_DIR/zipalign -v -p 4 "$APK_UNSIGNED" "$APK_ALIGNED"
          
          # Sign with apksigner
          echo "Signing APK..."
          $BUILD_TOOLS_DIR/apksigner sign \
            --ks ${{ env.KEYSTORE_PATH }} \
            --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
            --ks-pass pass:"${{ secrets.KEY_PASSWORD }}" \
            --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
            --out "$APK_SIGNED" \
            "$APK_ALIGNED"
          
          # Verify signature
          echo "Verifying signature..."
          $BUILD_TOOLS_DIR/apksigner verify -v "$APK_SIGNED"
          
          ls -lh "$APK_SIGNED"
          echo "âœ… APK signed successfully!"

      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: AAPS-debug-signed
          path: aaps-signed.apk
          retention-days: 30

      - name: Display build summary
        if: always()
        run: |
          echo "=== Build Summary ==="
          echo "Java Version:"
          java -version
          echo ""
          echo "Gradle Version:"
          ./gradlew --version
