name: Build AndroidAPS (debug-signed for update)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0

      - name: Grant execute to gradlew
        run: chmod +x ./gradlew

      - name: Clean git state
        run: |
          git reset --hard
          git clean -xfd

      - name: Build AAPS
        run: |
          ./gradlew clean :app:assembleAapsclientDebug --stacktrace || ./gradlew clean :app:assembleDebug --stacktrace

      - name: Find APK
        id: find-apk
        run: |
          APK_PATH=$(find app/build/outputs/apk -name "*.apk" -type f | head -1)
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find . -name "*.apk" -type f | grep -i "debug" | head -1)
          fi
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "Found APK: $APK_PATH"

      - name: Restore your debug.keystore
        run: |
          # Naudojate savo esamą keystore iš Android Studio
          echo "${{ secrets.DEBUG_KEYSTORE_BASE64 }}" | base64 -d > debug.keystore
          keytool -list -v -keystore debug.keystore -storepass android -alias androiddebugkey

      - name: Sign APK with your keystore
        run: |
          BUILD_TOOLS_DIR=$(find $ANDROID_HOME/build-tools -maxdepth 1 -type d | sort -V | tail -1)
          
          $BUILD_TOOLS_DIR/zipalign -f -p 4 "$APK_PATH" app-aligned.apk
          
          $BUILD_TOOLS_DIR/apksigner sign \
            --ks debug.keystore \
            --ks-key-alias androiddebugkey \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out aaps-debug-signed.apk \
            app-aligned.apk
          
          $BUILD_TOOLS_DIR/apksigner verify --verbose aaps-debug-signed.apk

      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: aaps-debug-signed
          path: aaps-debug-signed.apk
